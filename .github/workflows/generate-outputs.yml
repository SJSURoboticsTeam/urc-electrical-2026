name: Generate KiCad outputs
on:
  workflow_dispatch:
  workflow_call:
env:
  GIT_COMMITTER_NAME: ci-bot
  GIT_COMMITTER_EMAIL: sjsurobotics@gmail.com
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        projects:
          - servo:
            path: 40Vservo/40Vservo
            name: servo
          - drive:
            path: drive/drive
            name: drive
    steps:
    - uses: actions/checkout@v4
  
    - name: Export PDF
      id: production
      uses: SJSURoboticsTeam/kicad-action@v1.0.0
      with:
        kicad_sch: ${{ matrix.projects.path }}.kicad_sch
        kicad_pcb: ${{ matrix.projects.path }}.kicad_pcb
        sch_pdf: true
        sch_pdf_file:  ${{ matrix.projects.name }}.pdf
        pcb_image: true
        pcb_image_path: .

    - name: Get directory of outputs
      run: echo "OUTPUT_DIRECTORIES=`dirname ${{ matrix.projects.path }}`" >> "$GITHUB_ENV"

    - name: Upload production files
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() && steps.production.conclusion == 'success' }}
      with:
        name: ${{ matrix.projects.name }}-out
        path: |
          ${{ env.OUTPUT_DIRECTORIES }}/${{ matrix.projects.name }}.pdf
          ${{ env.OUTPUT_DIRECTORIES }}/top.png
          ${{ env.OUTPUT_DIRECTORIES }}/bottom.png